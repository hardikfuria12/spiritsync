<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Accept Pending Purchase</title>
  <link rel="icon" href="{{ url_for('static', filename='assets/favicon.png') }}" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 2rem;
      background-color: #F4E3C1; /* Warm sand */
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    h2 {
      color: #1F1F1F;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .section-box {
      background-color: #FFFDF9;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      padding: 24px;
      margin-bottom: 24px;
      max-width: 95%;
      margin-left: auto;
      margin-right: auto;
    }
    .btn-primary {
      background-color: #C29F59;
      border: none;
      font-weight: bold;
      border-radius: 8px;
      padding: 10px 18px;
    }
    .btn-primary:hover {
      background-color: #a17e3d;
    }
    table {
      background-color: #FFFDF9;
      border-radius: 12px;
      overflow: hidden;
      margin: 0 auto;
    }
    th, td {
      padding: 10px 16px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="section-box">
    <h2>üìù Pending Purchases</h2>

    <p><strong>Username:</strong> {{ user_id }}</p>
    <p><strong>Session:</strong> {{ session }}</p>
    <!-- <p><strong>File Path:</strong> {{ file_path }}</p> -->

    <div id="pending-table-wrapper" class="table-responsive">
      {{ pending_purchase_table | safe }}
    </div>

    <div class="text-center mt-3">
      <button class="btn btn-primary" onclick="triggerPurchase()">‚úÖ Accept TP's</button>
    </div>
    <!-- Password Prompt Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
          <div class="modal-header">
            <h5 class="modal-title" id="passwordModalLabel">üîê Enter Excise Password</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="password" id="excise-password" class="form-control" placeholder="Enter password">
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="confirmPurchase()">Confirm</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="loading-indicator" style="display: none; text-align: center; margin-top: 20px;">
    <img src="https://i.gifer.com/ZZ5H.gif" alt="Loading..." width="50" height="50" />
    <p>Uploading... Please wait</p>
  </div>

  <script>
    window.onload = function () {
      const wrapper = document.getElementById("pending-table-wrapper");
      const parser = new DOMParser();
      const tempDoc = parser.parseFromString(wrapper.innerHTML, 'text/html');
      const table = tempDoc.querySelector("table");

      if (table) {
        // Add checkbox header
        const headerRow = table.querySelector("thead tr");
        const th = document.createElement("th");
        th.textContent = "‚úî";
        headerRow.appendChild(th);

        // Add checkbox cells to each row
        table.querySelectorAll("tbody tr").forEach(row => {
          const td = document.createElement("td");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.classList.add("row-check");
          td.appendChild(checkbox);
          row.appendChild(td);
        });

        // Replace wrapper content with modified table
        wrapper.innerHTML = "";
        wrapper.appendChild(table);
      }
    }
    function triggerPurchase() {
      const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
      modal.show();
    }
    function confirmPurchase() {
      const password = document.getElementById("excise-password").value;
      const table = document.querySelector("#pending-table-wrapper table");
      const headers = Array.from(table.querySelectorAll("thead th"))
                          .map(th => th.textContent.trim())
                          .filter(h => h !== "‚úî"); // remove checkbox col

      let selected = [];
      selected.push(headers); // first row = headers

      table.querySelectorAll("tbody tr").forEach(row => {
        const checkbox = row.querySelector(".row-check");
        if (checkbox && checkbox.checked) {
          let rowData = [];
          row.querySelectorAll("td").forEach((cell, i) => {
            if (i < row.cells.length - 1) { // skip checkbox column
              rowData.push(cell.textContent.trim());
            }
          });
          selected.push(rowData);
        }
      });
      // Close modal
      const modalEl = document.getElementById('passwordModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();

      // Show loading GIF
      document.getElementById("loading-indicator").style.display = "block";

      const payload = {
        username: "{{ user_id }}",
        session: "{{ session }}",
        file_path: "{{ file_path }}",
        password: password,
        selected_rows: selected
      };
      fetch("/accept_purchase", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => res.text())
      .then(html => {
        // Replace entire page with new HTML (like result.html flow)
        document.open();
        document.write(html);
        document.close();
      })
      .catch(err => {
        console.error("‚ùå Error accepting purchase:", err);
        alert("Failed to accept purchases. Please try again.");
      });
    }
  </script>
</body>
</html>
